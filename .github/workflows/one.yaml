name: Deploy abc.txt to UAT

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  UAT_SITE_NAME: test   # IIS site name in IIS Manager

jobs:
  deploy-uat:
    runs-on: windows-latest   # must be Windows runner

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Create a simple file abc.txt
      - name: Create sample file
        shell: pwsh
        run: |
          New-Item -Path "$env:GITHUB_WORKSPACE\abc.txt" -ItemType File -Force
          Set-Content -Path "$env:GITHUB_WORKSPACE\abc.txt" -Value "Hello UAT deployment test!"

      - name: Show file contents
        shell: pwsh
        run: Get-Content "$env:GITHUB_WORKSPACE\abc.txt"

      - name: Deploy abc.txt to UAT with Web Deploy
        shell: pwsh
        run: |
          $msdeploy = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"

          if (!(Test-Path $msdeploy)) {
            Write-Error "msdeploy.exe not found at $msdeploy. Hosted Windows runners may not include Web Deploy."
          }

          # Build the destination string
          $dest = "contentPath=abc.txt" +
                  ",computerName=https://${{ secrets.DEPLOY_SERVER }}:8172/msdeploy.axd?site=$env:UAT_SITE_NAME" +
                  ",userName=${{ secrets.DEPLOY_USERNAME }}" +
                  ",password=${{ secrets.DEPLOY_PASSWORD }}" +
                  ",authType=Basic"

          & $msdeploy `
            -verb:sync `
            -source:contentPath="$env:GITHUB_WORKSPACE\abc.txt" `
            "-dest:$dest" `
            -allowUntrusted `
            -enableRule:AppOffline
