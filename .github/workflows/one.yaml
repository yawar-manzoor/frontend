name: Deploy abc.txt to UAT

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  UAT_SITE_NAME: test   # CHANGE THIS to your IIS site name

jobs:
  deploy-uat:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Create a simple file abc.txt
      - name: Create sample file
        run: |
          New-Item -Path "$env:GITHUB_WORKSPACE\abc.txt" -ItemType File -Force
          Set-Content -Path "$env:GITHUB_WORKSPACE\abc.txt" -Value "Hello UAT deployment test!"
        shell: pwsh

      - name: Show file
        run: Get-Content "$env:GITHUB_WORKSPACE\abc.txt"
        shell: pwsh

      - name: Deploy abc.txt to UAT with Web Deploy
        run: |
          $msdeploy = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"

          if (!(Test-Path $msdeploy)) {
            Write-Error "msdeploy.exe not found. Hosted Windows runners may not include Web Deploy."
          }

          & $msdeploy `
            -verb:sync `
            -source:contentPath="$env:GITHUB_WORKSPACE" `
            -dest:contentPath="$env:UAT_SITE_NAME",
                  computerName="https://${{ secrets.DEPLOY_SERVER }}:8172/msdeploy.axd?site=$env:UAT_SITE_NAME",
                  userName="${{ secrets.DEPLOY_USERNAME }}",
                  password="${{ secrets.DEPLOY_PASSWORD }}",
                  authType="Basic" `
            -allowUntrusted `
            -enableRule:AppOffline
        shell: pwsh
