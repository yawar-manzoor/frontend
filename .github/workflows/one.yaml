name: Deploy to UAT (CMD)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  UAT_SITE_NAME: test   # IIS site name in IIS Manager

jobs:
  deploy-uat:
    runs-on: windows-latest   # must be Windows runner

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Create a sample file for testing
      - name: Create sample file
        shell: pwsh
        run: |
          New-Item -Path "$env:GITHUB_WORKSPACE\abc.txt" -ItemType File -Force
          Set-Content -Path "$env:GITHUB_WORKSPACE\abc.txt" -Value "Hello UAT deployment test!"

      - name: Show file contents
        shell: pwsh
        run: Get-Content "$env:GITHUB_WORKSPACE\abc.txt"

      - name: Deploy to IIS with Web Deploy (CMD)
        shell: cmd
        run: |
          "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe" ^
           -verb:sync ^
           -source:contentPath="%GITHUB_WORKSPACE%\abc.txt" ^
           -dest:contentPath="abc.txt",computerName="https://${{ secrets.DEPLOY_SERVER }}:8172/msdeploy.axd?site=%UAT_SITE_NAME%",userName="${{ secrets.DEPLOY_USERNAME }}",password="${{ secrets.DEPLOY_PASSWORD }}",authType="Basic" ^
           -allowUntrusted ^
           -enableRule:AppOffline
